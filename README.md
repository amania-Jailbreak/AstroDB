# AstroDB

Database used by AstroNetwork (prototype)

TODO:

1. 検索パフォーマンスの改善（インデックスの活用）

現状の問題点:
現在、database.py の find や find_one といった検索メソッドは、インデックスを全く利用していません。クエリが実行され
るたびに、コレクション内のすべてのドキュメントを 1 つずつチェック（フルスキャン）しています。これではデータが数千、数
万件と増えた場合に、検索が非常に遅くなってしまいます。

改善案:
クエリにインデックスが作成されたフィールド（例：{"name": "AstroDB"} で name にインデックスがある場合）が含まれてい
れば、まずインデックスを使って候補となるドキュメントを高速に絞り込み、その絞り込んだ結果に対して残りのクエリ条件を
適用するようにロジックを修正します。これにより、検索パフォーマンスが劇的に向上します。

2. データの永続性（クラッシュ時のデータ損失リスク）

現状の問題点:
データベースへの変更は、サーバーが正常にシャットダウンする時 (lifespan マネージャー経由) にのみディスク
(database.adb) に保存されます。もしサーバーが予期せずクラッシュした場合、最後の保存以降のすべての変更（ユーザー登録
、データ挿入・更新・削除）が失われてしまいます。

改善案:
データの信頼性を高めるために、以下のいずれかの方法を導入することが考えられます。

-   書き込みごとの保存: insert_one, update_one, delete_one が成功するたびに save_to_disk() を呼び出します。最も安全
    ですが、書き込みのたびにディスク I/O が発生するため、パフォーマンスが少し低下する可能性があります。
-   定時保存: バックグラウンドで定期的に（例：1 分ごとに）save_to_disk()
    を実行するスレッドを動かします。クラッシュ時の損失を最小限に抑えつつ、パフォーマンスへの影響を軽減できます。

3. クライアントの操作性向上

現状の問題点:
client.py
はコマンドの解釈が非常にシンプルで、JSON データにスペースが含まれていると正しく処理できません。例えば、insert posts
{"title": "My new post"} のようなコマンドは失敗してしまいます。

改善案:
コマンドラインパーサーをより堅牢なものに修正します。例えば、コマンド名、コレクション名の後の文字列全体を JSON として
解釈するように変更することで、より複雑なドキュメントも簡単に追加できるようになります。

4. クエリエンジンの機能拡張

現状の問題点:
query_engine.py は基本的な演算子をサポートしていますが、より複雑な検索には対応していません。

改善案:
以下のような機能を追加することで、より柔軟なデータ検索が可能になります。

-   ネストされたオブジェクトの検索: {"user.profile.age": 25}
    のように、ドット記法で深い階層の値を検索できるようにします。
-   配列内の要素に対するクエリ: {"tags": "python"} というクエリで、tags 配列に "python"
    が含まれるドキュメントを検索できるようにします。（現在は配列の完全一致のみ）

---

これらの改善点の中で、特に興味があるものや、着手してほしいものはありますか？

> 洗い出した改善点をまとめて

✦ 承知いたしました。AstroDB プロジェクトの改善点を以下にまとめます。

---

AstroDB 改善提案まとめ

1. パフォーマンス

-   インデックスを活用した検索高速化:
    -   問題点: 現在の検索処理は、データ量に関わらず常に全件スキャン（フルスキャン）を行っており、パフォーマンスのボ
        トルネックとなっている。
    -   改善案: インデックスが利用可能なクエリでは、インデックスを使って候補を高速に絞り込むロジックを追加し、検索速
        度を劇的に向上させる。

2. 信頼性・堅牢性

-   データ永続性の強化:
    -   問題点: サーバーがクラッシュすると、最後の正常なシャットダウン以降の全データ変更が失われるリスクがある。
    -   改善案: データ変更時（書き込みごと）または定期的にデータベースをディスクに保存する仕組みを導入し、データ損失
        のリスクを最小限に抑える。

3. 操作性・利便性

-   クライアントのコマンド解釈能力の向上:
    -   問題点:
        コマンドラインクライアントが、スペースを含む JSON データを正しく扱えないため、複雑なドキュメントの挿入が困難。
    -   改善案: コマンドパーサーを修正し、より柔軟に JSON データを扱えるようにする。

4. 機能拡張

-   クエリエンジンの高度化:
    -   問題点: 現在のクエリエンジンでは、ネストされたオブジェクト内の値や、配列内の一部の要素での検索ができない。
    -   改善案:
        -   ドット記法 (user.profile.age) によるネストされたオブジェクトの検索機能を追加する。
        -   配列に特定の要素が含まれるかをチェックするクエリ機能を追加する。
